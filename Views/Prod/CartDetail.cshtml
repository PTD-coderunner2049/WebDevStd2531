@model List<WebDevStd2531.Models.CartItemViewModel>
@using Microsoft.AspNetCore.Identity
@using WebDevStd2531.AppData

@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager

@{
    ViewData["Title"] = "CartDetail";
	var totalLineItems = Model.Count;
}
<div class="span9">
	<ul class="breadcrumb">
		<li>
			<a asp-controller="Home"
			   asp-action="Index">
				Home
			</a> <span class="divider">/</span>
		</li>
		<li class="active"> Shopping Cart</li>
	</ul>
	
	@* Check for TempData error and display the alert firt UwU*@
	@if (TempData["StockError"] != null)
	{
		<div id="stock-error-alert" class="alert alert-error">
			<button type="button" class="close" data-dismiss="alert">×</button>
			<strong>Error!</strong> @TempData["StockError"]
		</div>
	}

	<h3>  SHOPPING CART [ <small> @totalLineItems Item(s) </small>]<a asp-controller="home" asp-action="Index" class="btn btn-large pull-right"><i class="icon-arrow-left"></i> Return to Shop </a></h3>
	<hr class="soft" />

	<table class="table table-bordered">
		<thead>
			<tr>
				<th>Product</th>
				<th>Description</th>
				@* Name and type *@
				<th>Quantity/Update</th>
				<th>Price</th>
				<th>Discount</th>
				<th>Tax</th>
				<th>Total</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var item in Model)
			{

				// Calculations from previous step (ensuring necessary variables are defined)
				double discountRate = (item.Discount ?? 0) / 100.0;
				double taxRate = (item.Tax ?? 0) / 100.0;
				int quantity = item.Quantity;

				double pricePerUnit = item.Price;
				double discountAmountPerUnit = pricePerUnit * discountRate;
				double discountedPricePerUnit = pricePerUnit - discountAmountPerUnit;
				double taxAmountPerUnit = pricePerUnit * taxRate;
				double finalPricePerUnit = discountedPricePerUnit + taxAmountPerUnit;
				double calculatedLineTotal = finalPricePerUnit * quantity;

				<tr id="row-@item.OrderProductId"
					data-price="@item.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)"
					data-discount="@((item.Discount ?? 0).ToString(System.Globalization.CultureInfo.InvariantCulture))"
					data-tax="@((item.Tax ?? 0).ToString(System.Globalization.CultureInfo.InvariantCulture))">
					<td>
						<img width="60" src="@item.ImageUrl" alt="@item.ProductName" />
					</td>
					<td>
						@item.ProductName
						<br />
						<small>@item.Description</small>
						<br />
						<small>Option: <strong>@item.SelectedType</strong></small>
					</td>
					<td>
						<div class="input-append">
							<input class="span1 cart-quantity-input"
								   style="max-width:34px"
								   placeholder="@item.Quantity"
								   id="qty-input-@item.OrderProductId"
								   size="16"
								   type="number"
								   value="@item.Quantity"
								   min="1"
								   max="@item.MaxStock"
								   data-id="@item.OrderProductId"
								   onchange="updateLineTotal(this)">
                
							@* <button class="btn btn-danger btn-remove" type="button" disabled> 
								<i class="icon-remove icon-white"></i>
							</button> *@
							<form asp-controller="Prod" asp-action="RemoveCartItem" method="post" style="display:inline;">
								@* This hidden input passes the unique ID of the item in the OrderProduct table *@
								<input type="hidden" name="OrderProductId" value="@item.OrderProductId" />

								<button class="btn btn-danger btn-remove" type="submit" title="Remove Item">
									<i class="icon-remove icon-white"></i>
								</button>
							</form>
						</div>
					</td>
					<td>
						$@item.Price.ToString("N2")
					</td>
					<td>
						@((item.Discount ?? 0).ToString("N0"))%
					</td>
					<td>
						@((item.Tax ?? 0).ToString("N0"))%
					</td>
					<td id="line-total-@item.OrderProductId">
						$@calculatedLineTotal.ToString("N2")
					</td>
				</tr>
			}
		</tbody>
	</table>
	<form asp-controller="Prod" asp-action="Pay" method="post" style="display:inline;">
		@for (int i = 0; i < Model.Count; i++)
		{
			// Bind the required properties of CartItemViewModel to hidden inputs
			<input type="hidden" name="list[@i].OrderProductId" value="@Model[i].OrderProductId" />
			<input type="hidden" name="list[@i].ProductId" value="@Model[i].ProductId" />
			<input type="hidden"
				   name="list[@i].Quantity"
				   value="@Model[i].Quantity"
				   id="hidden-qty-@Model[i].OrderProductId" />

			// Include other necessary properties like Price, Discount, Tax, etc.,
			// if needed in the final Pay processing but here I dont do that so...
		}

		<button type="submit" class="btn btn-large pull-right">
			Proceed <i class="icon-arrow-right"></i>
		</button>
	</form>
</div>
@section Scripts {
	<script>
		//  (1234.56 -> $1,234.56)
		function formatCurrency(value) {
			return '$' + parseFloat(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function updateLineTotal(inputElement) {
			const orderProductId = inputElement.getAttribute('data-id');
			const newQuantity = parseInt(inputElement.value);
			const row = document.getElementById(`row-${orderProductId}`);
			const totalCell = document.getElementById(`line-total-${orderProductId}`);
			const maxStock = parseInt(inputElement.getAttribute('max'));

			// Find the corresponding hidden input field using the new ID
			const hiddenQuantityInput = document.getElementById(`hidden-qty-${orderProductId}`);

			if (newQuantity < 1) {
				// Revert to 1 if user enters a negative or zero quantity
				inputElement.value = 1;
				if (hiddenQuantityInput) { hiddenQuantityInput.value = 1; }
				return;
			}

			if (newQuantity > maxStock) {
				// Revert to max stock if user exceeds limit
				alert(`Maximum stock for this item is ${maxStock}.`);
				inputElement.value = maxStock;
				if (hiddenQuantityInput) { hiddenQuantityInput.value = maxStock; }
				return;
			}

			const price = parseFloat(row.getAttribute('data-price'));
			const discountRate = parseFloat(row.getAttribute('data-discount')) / 100.0;
			const taxRate = parseFloat(row.getAttribute('data-tax')) / 100.0;

			const discountAmountPerUnit = price * discountRate;
			const discountedPricePerUnit = price - discountAmountPerUnit;
			const taxAmountPerUnit = price * taxRate;

			const finalPricePerUnit = discountedPricePerUnit + taxAmountPerUnit;

			const calculatedLineTotal = finalPricePerUnit * newQuantity;
			totalCell.innerText = formatCurrency(calculatedLineTotal);

			// Update the hidden input value so the correct quantity is submitted to the server
			if (hiddenQuantityInput) {
				hiddenQuantityInput.value = newQuantity;
			}
		}
	</script>
}