@model List<WebDevStd2531.Models.CartItemViewModel>
@using Microsoft.AspNetCore.Identity
@using WebDevStd2531.AppData

@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager

@{
	ViewData["Title"] = "CartDetail";
	var totalLineItems = Model.Count;
	var totalPrice = 0.00;
}
<div class="span9">
	<ul class="breadcrumb">
		<li>
			<a asp-controller="Home"
			   asp-action="Index">
				Home
			</a> <span class="divider">/</span>
		</li>
		<li class="active"> Shopping Cart</li>
	</ul>
	
	@* Check for TempData error and display the alert firt UwU*@
	@if (TempData["StockError"] != null)
	{
		<div id="stock-error-alert" class="alert alert-error">
			<button type="button" class="close" data-dismiss="alert">×</button>
			<strong>Error!</strong> @TempData["StockError"]
		</div>
	}

	<h3>  SHOPPING CART [ <small> @totalLineItems Item(s) </small>]<a asp-controller="home" asp-action="Index" class="btn btn-large pull-right"><i class="icon-arrow-left"></i> Return to Shop </a></h3>
	<hr class="soft" />

	<table class="table table-bordered">
		<thead>
			<tr>
				<th>Product</th>
				@* Name and type *@
				<th>Quantity/Update</th>
				<th>Price</th>
				<th>Discount</th>
				<th>Tax</th>
				<th>Total</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var item in Model)
			{
				// Calculations from previous step (ensuring necessary variables are defined)
				double discountRate = (item.Discount ?? 0) / 100.0;
				double taxRate = (item.Tax ?? 0) / 100.0;
				int quantity = item.Quantity;

				double pricePerUnit = item.Price;
				double discountAmountPerUnit = pricePerUnit * discountRate;
				double discountedPricePerUnit = pricePerUnit - discountAmountPerUnit;
				double taxAmountPerUnit = discountedPricePerUnit * taxRate;
				double finalPricePerUnit = discountedPricePerUnit + taxAmountPerUnit;
				double calculatedLineTotal = finalPricePerUnit * quantity;

				totalPrice += calculatedLineTotal;



				<tr id="row-@item.OrderProductId"
					data-price="@item.Price.ToString(System.Globalization.CultureInfo.InvariantCulture)"
					data-discount="@((item.Discount ?? 0).ToString(System.Globalization.CultureInfo.InvariantCulture))"
					data-tax="@((item.Tax ?? 0).ToString(System.Globalization.CultureInfo.InvariantCulture))"
					data-current-total="@calculatedLineTotal.ToString(System.Globalization.CultureInfo.InvariantCulture)">
					<td>
						<img width="60" src="@item.ImageUrl" alt="@item.ProductName" />
					</td>
					<td>
						@item.ProductName
						<br />
						<small>Option: <strong>@item.SelectedType</strong></small>
					</td>
					<td>
						<div class="input-append">
							<input class="span1 cart-quantity-input"
								   style="max-width:34px"
								   placeholder="@item.Quantity"
								   id="qty-input-@item.OrderProductId"
								   size="16"
								   type="number"
								   value="@item.Quantity"
								   min="1"
								   max="@item.MaxStock"
								   data-id="@item.OrderProductId"
								   onchange="updateLineTotal(this)">
                
							@* <button class="btn btn-danger btn-remove" type="button" disabled> 
								<i class="icon-remove icon-white"></i>
							</button> *@
							<form asp-controller="Cart" asp-action="RemoveCartItem" method="post" style="display:inline;">
								@* This hidden input passes the unique ID of the item in the OrderProduct table *@
								<input type="hidden" name="OrderProductId" value="@item.OrderProductId" />

								<button class="btn btn-danger btn-remove" type="submit" title="Remove Item">
									<i class="icon-remove icon-white"></i>
								</button>
							</form>
						</div>
					</td>
					<td>
						$@item.Price.ToString("N2")
					</td>
					<td>
						@((item.Discount ?? 0).ToString("N0"))%
					</td>
					<td>
						@((item.Tax ?? 0).ToString("N0"))%
					</td>
					<td id="line-total-@item.OrderProductId">
						$@calculatedLineTotal.ToString("N2")
					</td>
				</tr>
			}
		</tbody>
	</table>
	
	<hr class="soft" />
	<table class="table table-bordered">
		<tbody>
			<tr>
				<td>
					<span class="pull-right">
						<strong>Grand Total (Incl. Discount & Tax):</strong>
					</span>
				</td>
				<td>
					<span class="pull-right">
						<strong id="cart-grand-total">$@totalPrice.ToString("N2")</strong>
					</span>
				</td>
			</tr>
		</tbody>
	</table>
	<hr class="soft" />

	<form asp-controller="Cart" asp-action="ConfirmPay" method="post" style="display:inline;">
		@for (int i = 0; i < Model.Count; i++)
		{
			<input type="hidden" name="cartItems[@i].ProductName" value="@Model[i].ProductName" />
			<input type="hidden" name="cartItems[@i].OrderProductId" value="@Model[i].OrderProductId" />
			<input type="hidden" name="cartItems[@i].ProductId" value="@Model[i].ProductId" />
			<input type="hidden"
				   name="cartItems[@i].Quantity"
				   value="@Model[i].Quantity"
				   id="hidden-qty-@Model[i].OrderProductId" />
			<input type="hidden" name="cartItems[@i].Price" value="@Model[i].Price" />
			<input type="hidden" name="cartItems[@i].Discount" value="@Model[i].Discount" />
			<input type="hidden" name="cartItems[@i].Tax" value="@Model[i].Tax" />
			<input type="hidden" name="cartItems[@i].SelectedType" value="@Model[i].SelectedType" />
		}

		<button type="submit" class="btn btn-large pull-right">
			Proceed <i class="icon-arrow-right"></i>
		</button>
	</form>
</div>


@section Scripts {
	<script>
		//  (1234.56 -> $1,234.56)
		function formatCurrency(value) {
			return '$' + parseFloat(value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}
        
        function updateGrandTotal() {
            let grandTotal = 0;
            // Select all rows that start with "row-" Get the numeric total from the data attribute
            const cartRows = document.querySelectorAll('tr[id^="row-"]');

            cartRows.forEach(row => {
                const lineTotal = parseFloat(row.getAttribute('data-current-total'));
                if (!isNaN(lineTotal)) {
                    grandTotal += lineTotal;
                }
            });

            // Update the Grand Total display element
            const grandTotalElement = document.getElementById('cart-grand-total');
            if (grandTotalElement) {
                grandTotalElement.innerText = formatCurrency(grandTotal);
            }
        }

		function updateLineTotal(inputElement) {
			const orderProductId = inputElement.getAttribute('data-id');
			const newQuantity = parseInt(inputElement.value);
			const row = document.getElementById(`row-${orderProductId}`);
			const totalCell = document.getElementById(`line-total-${orderProductId}`);
			const maxStock = parseInt(inputElement.getAttribute('max'));

			const hiddenQuantityInput = document.getElementById(`hidden-qty-${orderProductId}`);

			if (newQuantity < 1) {
				inputElement.value = 1;
				if (hiddenQuantityInput) { hiddenQuantityInput.value = 1; }
                updateGrandTotal();
				return;
			}

			if (newQuantity > maxStock) {
				alert(`Maximum stock for this item is ${maxStock}.`);
				inputElement.value = maxStock;
				if (hiddenQuantityInput) { hiddenQuantityInput.value = maxStock; }
                updateGrandTotal();
				return;
			}

			const price = parseFloat(row.getAttribute('data-price'));
			const discountRate = parseFloat(row.getAttribute('data-discount')) / 100.0;
			const taxRate = parseFloat(row.getAttribute('data-tax')) / 100.0;

			const discountAmountPerUnit = price * discountRate;
			const discountedPricePerUnit = price - discountAmountPerUnit;
			const taxAmountPerUnit = discountedPricePerUnit * taxRate;

			const finalPricePerUnit = discountedPricePerUnit + taxAmountPerUnit;

			const calculatedLineTotal = finalPricePerUnit * newQuantity;
			
			totalCell.innerText = formatCurrency(calculatedLineTotal);
            row.setAttribute('data-current-total', calculatedLineTotal.toString());
            
            // Recalculate and update the Grand Total display
            updateGrandTotal(); 

			if (hiddenQuantityInput) {
				hiddenQuantityInput.value = newQuantity;
			}
		}
	</script>
}